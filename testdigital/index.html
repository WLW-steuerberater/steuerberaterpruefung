<!doctype html>
<html lang="de" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Texteditor</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .editor-content {
      min-height: 500px;
      outline: none;
    }
    
    .editor-content:focus {
      outline: none;
      border: none;
    }
    
    #editor {
      outline: none !important;
      border: none !important;
    }
    
    .toolbar-button {
      transition: all 0.2s;
    }
    
    .toolbar-button:hover {
      transform: translateY(-1px);
    }
    
    .toolbar-button:active {
      transform: translateY(0);
    }
    
    .toolbar-button.active {
      background-color: #3b82f6;
      color: white;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: #e5e7eb;"><!-- Login Screen -->
   <div id="loginScreen" class="min-h-full flex items-center justify-center px-4 py-8">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
     <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Online-PrÃ¼fung Anmeldung</h1>
     <p class="text-gray-600 mb-6 text-center">Hier mÃ¼ssten Sie bei Ihrer PrÃ¼fung Ihre zugeteilte Nummer eingeben. Bei uns bitte Ihren Namen.</p>
     <form id="loginForm" onsubmit="handleLogin(event)"><label for="kennummer" class="block text-sm font-semibold text-gray-700 mb-2">Kennummer / Name:</label> <input type="text" id="kennummer" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none mb-4" placeholder="Bitte eingeben..."> <label for="pruefungsname" class="block text-sm font-semibold text-gray-700 mb-2">Name der PrÃ¼fung:</label> <input type="text" id="pruefungsname" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none mb-6" placeholder="Bitte eingeben..."> <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg"> Anmelden </button>
     </form>
    </div>
   </div><!-- Confirmation Screen -->
   <div id="confirmationScreen" class="hidden min-h-full flex items-center justify-center px-4 py-8">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-2xl w-full">
     <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">BestÃ¤tigung</h1>
     <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
      <p class="text-gray-800 text-lg leading-relaxed">Hiermit bestÃ¤tige ich, dass ich mich mit meiner eigenen Kennummer <strong id="confirmedName" class="text-blue-600"></strong> eingeloggt habe und die nachfolgende Online-PrÃ¼fung alleine durchfÃ¼hren werde. Ich sehe mich heute physisch und psychisch dazu in der Lage, die PrÃ¼fung zu absolvieren.</p>
     </div><button onclick="startEditor()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg"> BestÃ¤tigen </button>
    </div>
   </div><!-- Editor Screen -->
   <div id="editorScreen" class="hidden min-h-full flex flex-col items-center py-8 px-4"><!-- Header with Kennummer, PrÃ¼fungsname, Timer, etc. -->
    <div class="w-full bg-white shadow-lg p-4 mb-4 flex justify-between items-start"><!-- Left: Kennummer and PrÃ¼fungsname -->
     <div class="flex gap-8 items-center">
      <div>
       <div class="text-sm font-semibold text-gray-600">
        Kennummer:
       </div>
       <div id="header-kennummer" class="text-lg font-bold text-gray-800"></div>
      </div>
      <div>
       <div class="text-lg font-bold text-blue-600" id="header-pruefungsname"></div>
      </div>
     </div><!-- Right: Controls -->
     <div class="flex items-center gap-4"><!-- GrÃ¶ÃŸe der Funktionsleiste -->
      <div class="flex gap-2 items-center"><button onclick="changeToolbarSize('small')" id="btn-small" class="px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-sm"> A </button> <button onclick="changeToolbarSize('medium')" id="btn-medium" class="px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-base font-semibold"> A </button> <button onclick="changeToolbarSize('large')" id="btn-large" class="px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-lg font-bold"> A </button>
      </div><!-- Timer -->
      <div class="text-center">
       <div id="timer" class="text-2xl font-bold text-gray-800">
        06:00 Stunden
       </div>
      </div><!-- PrÃ¼fung beenden Button --> <button onclick="showEndExamDialog()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-lg shadow-lg transition-all"> PrÃ¼fung beenden </button>
     </div>
    </div><!-- Toolbar -->
    <div class="w-full bg-white shadow-lg p-3 flex flex-wrap gap-2 border-b-2 border-gray-200 mb-2"><!-- 1. RÃ¼ckgÃ¤ngig --> <button onclick="undo()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="RÃ¼ckgÃ¤ngig (Strg+Z)"> ï¿½ï¿½ï¿½ï¿½ï¿½ </button> <!-- 2. Wiederholen --> <button onclick="redo()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Wiederholen (Strg+Y)"> â†· </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 3. Ausschneiden --> <button onclick="cutText()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Ausschneiden (Strg+X)"> âœ‚ </button> <!-- 4. Kopieren --> <button onclick="copyText()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Kopieren (Strg+C)"> ðŸ“‹ </button> <!-- 5. EinfÃ¼gen --> <button onclick="pasteText()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="EinfÃ¼gen (Strg+V)"> ðŸ“„ </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 5b. Seitenumbruch --> <button onclick="insertPageBreak()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Seitenumbruch"> âŽ¯âŽ¯ </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 6. Kopfzeile oder Absatz --> <select id="formatType" onchange="changeFormatType(this.value)" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 border-none cursor-pointer" title="Format"> <option value="p" selected>Absatz</option> <option value="h1">Kopfzeile 1</option> <option value="h2">Kopfzeile 2</option> <option value="h3">Kopfzeile 3</option> </select>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 7. Texthervorhebungsfarbe --> <select onchange="highlightText(this.value)" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 border-none cursor-pointer" title="Texthervorhebung"> <option value="">Farbauswahl aufheben</option> <option value="#d3d3d3">Grau</option> </select>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 8. Fett --> <button onclick="formatText('bold')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 font-bold" title="Fett"> B </button> <!-- 9. Kursiv --> <button onclick="formatText('italic')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 italic" title="Kursiv"> I </button> <!-- 10. Durchgestrichen --> <button onclick="formatText('strikeThrough')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 line-through" title="Durchgestrichen"> S </button> <!-- 11. Hochgestellt --> <button onclick="formatText('superscript')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Hochgestellt"> xÂ² </button> <!-- 12. Tiefgestellt --> <button onclick="formatText('subscript')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Tiefgestellt"> xâ‚‚ </button> <!-- 13. Rot unterstrichen --> <button onclick="redUnderline()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-red-600 underline" title="Rot unterstrichen"> U </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 14. LinksbÃ¼ndig --> <button onclick="formatText('justifyLeft')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="LinksbÃ¼ndig"> ï¿½ï¿½ï¿½ï¿½ï¿½ </button> <!-- 15. Zentrieren --> <button onclick="formatText('justifyCenter')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Zentrieren"> â†” </button> <!-- 16. RechtsbÃ¼ndig --> <button onclick="formatText('justifyRight')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="RechtsbÃ¼ndig"> âž¡ </button> <!-- 17. Blocksatz --> <button onclick="formatText('justifyFull')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Blocksatz"> ï¿½ï¿½ï¿½ </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 18. AufzÃ¤hlung --> <button onclick="formatText('insertUnorderedList')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="AufzÃ¤hlung">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line> <line x1="8" y1="12" x2="21" y2="12"></line> <line x1="8" y1="18" x2="21" y2="18"></line> <circle cx="4" cy="6" r="1" fill="currentColor"></circle> <circle cx="4" cy="12" r="1" fill="currentColor"></circle> <circle cx="4" cy="18" r="1" fill="currentColor"></circle>
      </svg></button> <!-- 19. Nummerierte Liste --> <button onclick="formatText('insertOrderedList')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Nummerierte Liste">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="10" y1="6" x2="21" y2="6"></line> <line x1="10" y1="12" x2="21" y2="12"></line> <line x1="10" y1="18" x2="21" y2="18"></line> <path d="M4 6h1v4" stroke-width="1.5"></path> <path d="M4 10h2" stroke-width="1.5"></path> <path d="M6 15H4c0-1 2-2 2-3s-1-1.5-1-1.5S4 11 4 12" stroke-width="1.5"></path> <path d="M4 19h2v-1H5v-1h1" stroke-width="1.5"></path>
      </svg></button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 20. GeschÃ¼tztes Leerzeichen --> <button onclick="insertNonBreakingSpace()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="GeschÃ¼tztes Leerzeichen">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="10" width="4" height="4" fill="currentColor" opacity="0.3"></rect> <rect x="14" y="10" width="4" height="4" fill="currentColor" opacity="0.3"></rect>
      </svg></button> <!-- 21. Einzug verkleinern --> <button onclick="formatText('outdent')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Einzug verkleinern">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"></polyline> <line x1="18" y1="18" x2="6" y2="18"></line> <line x1="18" y1="14" x2="13" y2="14"></line> <line x1="18" y1="10" x2="13" y2="10"></line> <line x1="18" y1="6" x2="6" y2="6"></line>
      </svg></button> <!-- 22. Einzug vergrÃ¶ÃŸern --> <button onclick="formatText('indent')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Einzug vergrÃ¶ÃŸern">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 7 18 12 13 17"></polyline> <line x1="18" y1="18" x2="6" y2="18"></line> <line x1="18" y1="14" x2="13" y2="14"></line> <line x1="18" y1="10" x2="13" y2="10"></line> <line x1="18" y1="6" x2="6" y2="6"></line>
      </svg></button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 23. Tabelle einfÃ¼gen --> <button onclick="showTableDialog()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Tabelle einfÃ¼gen">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect> <line x1="3" y1="9" x2="21" y2="9"></line> <line x1="3" y1="15" x2="21" y2="15"></line> <line x1="9" y1="3" x2="9" y2="21"></line> <line x1="15" y1="3" x2="15" y2="21"></line>
      </svg></button>
    </div><!-- Table Dialog -->
    <div id="tableDialog" class="hidden w-full bg-white shadow-lg p-4 mb-2">
     <h3 class="font-bold mb-3 text-lg">Tabelle einfÃ¼gen</h3>
     <div class="flex gap-4 items-end">
      <div><label class="block text-sm mb-1">Zeilen:</label> <input type="number" id="tableRows" value="3" min="1" max="20" class="border rounded px-3 py-2 w-20">
      </div>
      <div><label class="block text-sm mb-1">Spalten:</label> <input type="number" id="tableCols" value="3" min="1" max="10" class="border rounded px-3 py-2 w-20">
      </div><button onclick="insertTable()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded"> EinfÃ¼gen </button> <button onclick="hideTableDialog()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded"> Abbrechen </button>
     </div>
    </div><!-- Editor Area -->
    <div class="w-full max-w-4xl bg-white rounded-b-lg shadow-lg mb-8 flex" style="min-height: 600px;"><!-- Korrekturrand (1/3 der Breite) - unsichtbar -->
     <div class="w-1/3 bg-white p-4">
     </div><!-- Schreibbereich (2/3 der Breite) -->
     <div class="w-2/3 p-8">
      <div id="editor" class="editor-content" contenteditable="true" style="font-family: 'Georgia', serif; font-size: 16px; line-height: 1.6; color: #333; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap;">
      </div>
     </div>
    </div><!-- Action Buttons -->
    <div class="w-full max-w-4xl flex gap-3 justify-center"><button onclick="clearEditor()" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold shadow-lg transition-all"> Alles lÃ¶schen </button> <button onclick="downloadDocument()" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold shadow-lg transition-all"> Als PDF herunterladen </button>
    </div>
   </div><!-- End Exam Confirmation Dialog -->
   <div id="endExamDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
     <h2 class="text-2xl font-bold text-gray-800 mb-4">PrÃ¼fung beenden?</h2>
     <p class="text-gray-700 mb-6">Wollen Sie die PrÃ¼fung wirklich endgÃ¼ltig beenden?</p>
     <div class="flex gap-4 justify-end"><button onclick="hideEndExamDialog()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-lg transition-all"> Nein </button> <button onclick="endExam()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-all"> Ja, PrÃ¼fung beenden </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      document_title: "Mein Dokument"
    };

    let userKennummer = "";
    let pruefungsname = "";
    let remainingMinutes = 360; // 6 Stunden = 360 Minuten
    let timerInterval = null;

    // Handle login form submission
    function handleLogin(event) {
      event.preventDefault();
      userKennummer = document.getElementById('kennummer').value.trim();
      pruefungsname = document.getElementById('pruefungsname').value.trim();
      
      if (userKennummer && pruefungsname) {
        // Hide login screen
        document.getElementById('loginScreen').classList.add('hidden');
        
        // Show confirmation screen with user's name
        document.getElementById('confirmedName').textContent = userKennummer;
        document.getElementById('confirmationScreen').classList.remove('hidden');
      }
    }

    // Start the editor
    function startEditor() {
      document.getElementById('confirmationScreen').classList.add('hidden');
      document.getElementById('editorScreen').classList.remove('hidden');
      
      // Update header with user info
      document.getElementById('header-kennummer').textContent = userKennummer;
      document.getElementById('header-pruefungsname').textContent = pruefungsname;
      
      // Start timer immediately when confirmation button is clicked
      startTimer();
    }

    // Timer functions
    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        remainingMinutes--;
        updateTimerDisplay();
        
        if (remainingMinutes <= 0) {
          clearInterval(timerInterval);
          showTimeUpDialog();
        }
      }, 60000); // Update every minute (60000 ms)
      
      // Also update every second for more accurate countdown display
      setInterval(() => {
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const timerElement = document.getElementById('timer');
      const hours = Math.floor(remainingMinutes / 60);
      const minutes = remainingMinutes % 60;
      const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} Stunden`;
      timerElement.textContent = formattedTime;
      
      // Keep timer color neutral
      timerElement.classList.add('text-gray-800');
    }

    function showTimeUpDialog() {
      const dialog = document.createElement('div');
      dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      dialog.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
          <h2 class="text-2xl font-bold text-red-600 mb-4">Zeit abgelaufen!</h2>
          <p class="text-gray-700 mb-6">Die PrÃ¼fungszeit ist abgelaufen. Bitte laden Sie Ihr Dokument herunter.</p>
          <button onclick="downloadDocument()" class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">
            Dokument herunterladen
          </button>
        </div>
      `;
      document.body.appendChild(dialog);
    }

    // Change toolbar size
    function changeToolbarSize(size) {
      const toolbar = document.querySelector('#editorScreen > div:nth-of-type(2)');
      
      // Remove active state from all buttons
      document.getElementById('btn-small').className = 'px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-sm';
      document.getElementById('btn-medium').className = 'px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-base font-semibold';
      document.getElementById('btn-large').className = 'px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-lg font-bold';
      
      if (size === 'small') {
        toolbar.classList.remove('p-3');
        toolbar.classList.add('p-2');
        toolbar.style.fontSize = '12px';
        document.getElementById('btn-small').className = 'px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-sm';
      } else if (size === 'large') {
        toolbar.classList.remove('p-3');
        toolbar.classList.add('p-4');
        toolbar.style.fontSize = '16px';
        document.getElementById('btn-large').className = 'px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-lg font-bold';
      } else {
        toolbar.classList.remove('p-2', 'p-4');
        toolbar.classList.add('p-3');
        toolbar.style.fontSize = '14px';
        document.getElementById('btn-medium').className = 'px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-base font-semibold';
      }
    }

    // End exam dialog functions
    function showEndExamDialog() {
      document.getElementById('endExamDialog').classList.remove('hidden');
    }

    function hideEndExamDialog() {
      document.getElementById('endExamDialog').classList.add('hidden');
    }

    async function endExam() {
      clearInterval(timerInterval);
      hideEndExamDialog();
      
      // Show confirmation message
      const message = document.createElement('div');
      message.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
      message.textContent = 'PrÃ¼fung beendet. PDF wird heruntergeladen...';
      document.body.appendChild(message);
      
      // Wait a moment for the message to be visible, then download
      await new Promise(resolve => setTimeout(resolve, 500));
      await downloadDocument();
      
      setTimeout(() => {
        message.remove();
      }, 3000);
    }

    // Format text in editor
    function formatText(command) {
      document.execCommand(command, false, null);
      document.getElementById('editor').focus();
    }

    // 1. RÃ¼ckgÃ¤ngig machen
    function undo() {
      document.execCommand('undo', false, null);
      document.getElementById('editor').focus();
    }

    // 2. Wiederholen
    function redo() {
      document.execCommand('redo', false, null);
      document.getElementById('editor').focus();
    }

    // 3. Ausschneiden
    async function cutText() {
      try {
        const selection = window.getSelection();
        if (selection.toString()) {
          await navigator.clipboard.writeText(selection.toString());
          document.execCommand('delete', false, null);
        }
      } catch (err) {
        // Fallback zu execCommand
        document.execCommand('cut', false, null);
      }
      document.getElementById('editor').focus();
    }

    // 4. Kopieren
    async function copyText() {
      try {
        const selection = window.getSelection();
        if (selection.toString()) {
          await navigator.clipboard.writeText(selection.toString());
        }
      } catch (err) {
        // Fallback zu execCommand
        document.execCommand('copy', false, null);
      }
      document.getElementById('editor').focus();
    }

    // 5. Einfï¿½ï¿½gen
    async function pasteText() {
      try {
        const text = await navigator.clipboard.readText();
        document.execCommand('insertText', false, text);
      } catch (err) {
        // Fallback zu execCommand
        document.execCommand('paste', false, null);
      }
      document.getElementById('editor').focus();
    }

    // 5b. Seitenumbruch einfÃ¼gen
    function insertPageBreak() {
      const pageBreak = '<div style="page-break-after: always; border-top: 2px dashed #999; margin: 20px 0; padding-top: 20px;"></div>';
      document.execCommand('insertHTML', false, pageBreak);
      document.getElementById('editor').focus();
    }

    // 6. Kopfzeile oder Absatz Ã¤ndern
    function changeFormatType(tag) {
      document.execCommand('formatBlock', false, tag);
      document.getElementById('editor').focus();
    }

    // 7. Texthervorhebungsfarbe
    function highlightText(color) {
      if (color === '') {
        document.execCommand('removeFormat', false, null);
      } else {
        document.execCommand('backColor', false, color);
      }
      document.getElementById('editor').focus();
    }

    // 13. Rot unterstrichen
    function redUnderline() {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.textDecoration = 'underline';
        span.style.textDecorationColor = 'red';
        span.style.textDecorationThickness = '2px';
        try {
          range.surroundContents(span);
        } catch (e) {
          // Fallback fÃ¼r komplexe Auswahlen
          const contents = range.extractContents();
          span.appendChild(contents);
          range.insertNode(span);
        }
      }
      document.getElementById('editor').focus();
    }

    // 20. GeschÃ¼tztes Leerzeichen
    function insertNonBreakingSpace() {
      document.execCommand('insertHTML', false, '&nbsp;');
      document.getElementById('editor').focus();
    }

    // 23. Tabelle Dialog anzeigen
    function showTableDialog() {
      document.getElementById('tableDialog').classList.remove('hidden');
    }

    function hideTableDialog() {
      document.getElementById('tableDialog').classList.add('hidden');
    }

    // Tabelle einfÃ¼gen
    function insertTable() {
      const rows = parseInt(document.getElementById('tableRows').value);
      const cols = parseInt(document.getElementById('tableCols').value);
      
      let tableHTML = '<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">';
      
      for (let i = 0; i < rows; i++) {
        tableHTML += '<tr>';
        for (let j = 0; j < cols; j++) {
          tableHTML += '<td style="border: 1px solid #333; padding: 8px; min-width: 60px;">&nbsp;</td>';
        }
        tableHTML += '</tr>';
      }
      
      tableHTML += '</table><p><br></p>';
      
      document.execCommand('insertHTML', false, tableHTML);
      hideTableDialog();
      document.getElementById('editor').focus();
    }

    // TastaturkÃ¼rzel
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 'z':
            if (!e.shiftKey) {
              e.preventDefault();
              undo();
            }
            break;
          case 'y':
            e.preventDefault();
            redo();
            break;
          case 'x':
            // Browser-Standard wird verwendet
            break;
          case 'c':
            // Browser-Standard wird verwendet
            break;
          case 'v':
            // Browser-Standard wird verwendet
            break;
        }
      }
    });

    // Clear editor
    function clearEditor() {
      const editor = document.getElementById('editor');
      editor.innerHTML = '';
      editor.focus();
    }

    // Download document as PDF (text-based)
    async function downloadDocument() {
      const editor = document.getElementById('editor');
      
      // Show loading message
      const loadingMessage = document.createElement('div');
      loadingMessage.id = 'pdf-loading';
      loadingMessage.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      loadingMessage.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 text-center">
          <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
          <h2 class="text-xl font-bold text-gray-800 mb-2">PDF wird erstellt...</h2>
          <p class="text-gray-600">Bitte warten Sie einen Moment.</p>
        </div>
      `;
      document.body.appendChild(loadingMessage);
      
      // Wait a moment for the loading message to render
      await new Promise(resolve => setTimeout(resolve, 100));
      
      try {
        // PDF erstellen
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const margin = 20;
        const contentWidth = pdfWidth - 2 * margin;
        const lineHeight = 7;
        const headerHeight = 20;
        let yPosition = headerHeight + margin;
        let pageNumber = 1;
        
        // Set default font
        pdf.setFont('helvetica');
        
        // Function to add header to page
        function addHeader(pageNum) {
          pdf.setFontSize(10);
          pdf.setTextColor(60, 60, 60);
          pdf.text(userKennummer, margin, 12);
          pdf.text(pruefungsname, pdfWidth / 2, 12, { align: 'center' });
          pdf.text(`Seite ${pageNum}`, pdfWidth - margin, 12, { align: 'right' });
          pdf.setLineWidth(0.3);
          pdf.setDrawColor(200, 200, 200);
          pdf.line(margin, 15, pdfWidth - margin, 15);
        }
        
        // Function to add new page
        function addNewPage() {
          pdf.addPage();
          pageNumber++;
          yPosition = headerHeight + margin;
          addHeader(pageNumber);
        }
        
        // Function to check if we need a new page
        function checkNewPage(requiredSpace) {
          if (yPosition + requiredSpace > pdfHeight - margin) {
            addNewPage();
            return true;
          }
          return false;
        }
        
        // Add first page header
        addHeader(pageNumber);
        
        // Parse HTML content
        function parseElement(element, isBold = false, isItalic = false, isUnderline = false, isStrikethrough = false) {
          const tagName = element.tagName ? element.tagName.toLowerCase() : '';
          
          // Handle text nodes
          if (element.nodeType === Node.TEXT_NODE) {
            const text = element.textContent.trim();
            if (text) {
              // Apply formatting
              let fontStyle = '';
              if (isBold && isItalic) fontStyle = 'bolditalic';
              else if (isBold) fontStyle = 'bold';
              else if (isItalic) fontStyle = 'italic';
              else fontStyle = 'normal';
              
              pdf.setFont('helvetica', fontStyle);
              
              // Split text into lines that fit
              const lines = pdf.splitTextToSize(text, contentWidth);
              
              lines.forEach(line => {
                checkNewPage(lineHeight);
                
                if (isStrikethrough) {
                  const textWidth = pdf.getTextWidth(line);
                  pdf.text(line, margin, yPosition);
                  pdf.line(margin, yPosition - 2, margin + textWidth, yPosition - 2);
                } else if (isUnderline) {
                  const textWidth = pdf.getTextWidth(line);
                  pdf.text(line, margin, yPosition);
                  pdf.line(margin, yPosition + 1, margin + textWidth, yPosition + 1);
                } else {
                  pdf.text(line, margin, yPosition);
                }
                
                yPosition += lineHeight;
              });
            }
            return;
          }
          
          // Handle different HTML elements
          switch(tagName) {
            case 'h1':
              checkNewPage(lineHeight * 1.5);
              pdf.setFontSize(20);
              pdf.setFont('helvetica', 'bold');
              const h1Text = element.textContent.trim();
              if (h1Text) {
                const h1Lines = pdf.splitTextToSize(h1Text, contentWidth);
                h1Lines.forEach(line => {
                  pdf.text(line, margin, yPosition);
                  yPosition += lineHeight * 1.5;
                });
              }
              yPosition += lineHeight * 0.5;
              pdf.setFontSize(12);
              break;
              
            case 'h2':
              checkNewPage(lineHeight * 1.3);
              pdf.setFontSize(16);
              pdf.setFont('helvetica', 'bold');
              const h2Text = element.textContent.trim();
              if (h2Text) {
                const h2Lines = pdf.splitTextToSize(h2Text, contentWidth);
                h2Lines.forEach(line => {
                  pdf.text(line, margin, yPosition);
                  yPosition += lineHeight * 1.3;
                });
              }
              yPosition += lineHeight * 0.3;
              pdf.setFontSize(12);
              break;
              
            case 'h3':
              checkNewPage(lineHeight * 1.2);
              pdf.setFontSize(14);
              pdf.setFont('helvetica', 'bold');
              const h3Text = element.textContent.trim();
              if (h3Text) {
                const h3Lines = pdf.splitTextToSize(h3Text, contentWidth);
                h3Lines.forEach(line => {
                  pdf.text(line, margin, yPosition);
                  yPosition += lineHeight * 1.2;
                });
              }
              yPosition += lineHeight * 0.2;
              pdf.setFontSize(12);
              break;
              
            case 'p':
            case 'div':
              // Check for page break
              if (element.style.pageBreakAfter === 'always') {
                addNewPage();
              } else {
                Array.from(element.childNodes).forEach(child => {
                  parseElement(child, isBold, isItalic, isUnderline, isStrikethrough);
                });
                yPosition += lineHeight * 0.5;
              }
              break;
              
            case 'br':
              yPosition += lineHeight;
              checkNewPage(lineHeight);
              break;
              
            case 'b':
            case 'strong':
              Array.from(element.childNodes).forEach(child => {
                parseElement(child, true, isItalic, isUnderline, isStrikethrough);
              });
              break;
              
            case 'i':
            case 'em':
              Array.from(element.childNodes).forEach(child => {
                parseElement(child, isBold, true, isUnderline, isStrikethrough);
              });
              break;
              
            case 'u':
              Array.from(element.childNodes).forEach(child => {
                parseElement(child, isBold, isItalic, true, isStrikethrough);
              });
              break;
              
            case 'strike':
            case 's':
              Array.from(element.childNodes).forEach(child => {
                parseElement(child, isBold, isItalic, isUnderline, true);
              });
              break;
              
            case 'span':
              // Check for red underline
              const hasRedUnderline = element.style.textDecorationColor === 'red' || 
                                     element.style.textDecoration.includes('underline');
              
              Array.from(element.childNodes).forEach(child => {
                parseElement(child, isBold, isItalic, hasRedUnderline, isStrikethrough);
              });
              break;
              
            case 'ul':
            case 'ol':
              let listIndex = 1;
              Array.from(element.children).forEach(li => {
                if (li.tagName.toLowerCase() === 'li') {
                  checkNewPage(lineHeight);
                  const bullet = tagName === 'ul' ? 'â€¢ ' : `${listIndex}. `;
                  pdf.setFont('helvetica', 'normal');
                  pdf.text(bullet, margin, yPosition);
                  
                  const textX = margin + 10;
                  const liText = li.textContent.trim();
                  const liLines = pdf.splitTextToSize(liText, contentWidth - 10);
                  
                  liLines.forEach((line, idx) => {
                    if (idx > 0) {
                      checkNewPage(lineHeight);
                    }
                    pdf.text(line, textX, yPosition);
                    yPosition += lineHeight;
                  });
                  
                  listIndex++;
                }
              });
              yPosition += lineHeight * 0.5;
              break;
              
            case 'table':
              checkNewPage(lineHeight * 2);
              
              const rows = Array.from(element.querySelectorAll('tr'));
              const colWidths = [];
              
              // Calculate column widths
              if (rows.length > 0) {
                const firstRow = rows[0];
                const cells = Array.from(firstRow.querySelectorAll('td, th'));
                const numCols = cells.length;
                const colWidth = contentWidth / numCols;
                
                for (let i = 0; i < numCols; i++) {
                  colWidths.push(colWidth);
                }
              }
              
              // Draw table
              rows.forEach((row, rowIdx) => {
                const cells = Array.from(row.querySelectorAll('td, th'));
                const rowHeight = lineHeight * 1.5;
                
                checkNewPage(rowHeight);
                
                let xPos = margin;
                cells.forEach((cell, colIdx) => {
                  // Draw cell border
                  pdf.rect(xPos, yPosition - 5, colWidths[colIdx], rowHeight);
                  
                  // Draw cell text
                  const cellText = cell.textContent.trim();
                  if (cellText) {
                    pdf.text(cellText, xPos + 2, yPosition);
                  }
                  
                  xPos += colWidths[colIdx];
                });
                
                yPosition += rowHeight;
              });
              
              yPosition += lineHeight * 0.5;
              break;
              
            default:
              // For other elements, process children
              Array.from(element.childNodes).forEach(child => {
                parseElement(child, isBold, isItalic, isUnderline, isStrikethrough);
              });
              break;
          }
        }
        
        // Parse the editor content
        Array.from(editor.childNodes).forEach(node => {
          parseElement(node);
        });
        
        // Save PDF
        pdf.save(`${pruefungsname}_${userKennummer}.pdf`);
        
        // Remove loading message
        loadingMessage.remove();
        
        // Show success message
        const successMessage = document.createElement('div');
        successMessage.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
        successMessage.textContent = 'PDF erfolgreich heruntergeladen!';
        document.body.appendChild(successMessage);
        
        setTimeout(() => {
          successMessage.remove();
        }, 3000);
        
      } catch (error) {
        console.error('Fehler beim PDF-Export:', error);
        
        // Remove loading message
        const loading = document.getElementById('pdf-loading');
        if (loading) loading.remove();
        
        // Show error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
        errorMessage.textContent = 'Fehler beim PDF-Export. Bitte versuchen Sie es erneut.';
        document.body.appendChild(errorMessage);
        
        setTimeout(() => {
          errorMessage.remove();
        }, 5000);
      }
    }

    // Element SDK implementation
    async function onConfigChange(config) {
      const titleElement = document.getElementById('doc-title');
      titleElement.textContent = config.document_title || defaultConfig.document_title;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["document_title", config.document_title || defaultConfig.document_title]
      ]);
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ad7af9aa152e0d3',t:'MTc2NTY1MjIzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
