<!doctype html>
<html lang="de" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Texteditor</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .editor-content {
      min-height: 500px;
      outline: none;
    }
    
    .editor-content:focus {
      outline: none;
      border: none;
    }
    
    #editor {
      outline: none !important;
      border: none !important;
    }
    
    /* List styles */
    #editor ul {
      list-style-type: disc;
      margin-left: 30px;
      padding-left: 10px;
    }
    
    #editor ol {
      list-style-type: decimal;
      margin-left: 30px;
      padding-left: 10px;
    }
    
    #editor li {
      margin: 5px 0;
    }
    
    /* Heading styles */
    #editor h2 {
      font-size: 22px;
      font-weight: bold;
      margin: 15px 0 10px 0;
      line-height: 1.3;
    }
    
    .toolbar-button {
      transition: all 0.2s;
    }
    
    .toolbar-button:hover {
      transform: translateY(-1px);
    }
    
    .toolbar-button:active {
      transform: translateY(0);
    }
    
    .toolbar-button.active {
      background-color: #3b82f6;
      color: white;
    }

    /* Print Styles */
    @media print {
      /* Hide everything except print content */
      body * {
        visibility: hidden;
      }
      
      #printContent, #printContent * {
        visibility: visible;
      }
      
      #printContent {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        display: block !important;
      }
      
      /* Page setup */
      @page {
        size: A4;
        margin: 2cm;
      }
      
      /* Print header on every page */
      .print-header {
        display: block;
        padding: 15px 0;
        border-bottom: 2px solid #333;
        margin-bottom: 30px;
        font-size: 11pt;
        page-break-after: avoid;
      }
      
      /* Print content */
      .print-content {
        display: block;
        margin-top: 0;
        padding-top: 0;
        font-family: 'Georgia', serif;
        font-size: 12pt;
        line-height: 1.6;
        color: #000;
      }
      
      /* Handle page breaks */
      .print-content div[style*="page-break-after: always"] {
        page-break-after: always;
      }
      
      /* Table styles for print */
      .print-content table {
        border-collapse: collapse;
        width: 100%;
        page-break-inside: avoid;
      }
      
      .print-content table td {
        border: 1px solid #000;
        padding: 5px;
      }
      
      /* Avoid breaks inside elements */
      .print-content h1, .print-content h2, .print-content h3 {
        page-break-after: avoid;
      }
      
      .print-content p {
        orphans: 3;
        widows: 3;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: #e5e7eb;"><!-- Login Screen -->
   <div id="loginScreen" class="min-h-full flex items-center justify-center px-4 py-8">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
     <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Online-PrÃ¼fung Anmeldung</h1>
     <p class="text-gray-600 mb-6 text-center">Hier mÃ¼ssten Sie bei Ihrer PrÃ¼fung Ihre zugeteilte Nummer eingeben. Bei uns bitte Ihren Namen.</p>
     <form id="loginForm" onsubmit="handleLogin(event)"><label for="kennummer" class="block text-sm font-semibold text-gray-700 mb-2">Kennummer / Name:</label> <input type="text" id="kennummer" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none mb-4" placeholder="Bitte eingeben..."> <label for="pruefungsname" class="block text-sm font-semibold text-gray-700 mb-2">Name der PrÃ¼fung:</label> <input type="text" id="pruefungsname" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none mb-6" placeholder="Bitte eingeben..."> <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg"> Anmelden </button>
     </form>
    </div>
   </div><!-- Confirmation Screen -->
   <div id="confirmationScreen" class="hidden min-h-full flex items-center justify-center px-4 py-8">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-2xl w-full">
     <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Bestï¿½ï¿½tigung</h1>
     <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
      <p class="text-gray-800 text-lg leading-relaxed">Hiermit bestÃ¤tige ich, dass ich mich mit meiner eigenen Kennummer <strong id="confirmedName" class="text-blue-600"></strong> eingeloggt habe und die nachfolgende Online-PrÃ¼fung alleine durchfÃ¼hren werde. Ich sehe mich heute physisch und psychisch dazu in der Lage, die PrÃ¼fung zu absolvieren.</p>
     </div><button onclick="startEditor()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg"> BestÃ¤tigen </button>
    </div>
   </div><!-- Editor Screen -->
   <div id="editorScreen" class="hidden min-h-full flex flex-col items-center py-8 px-4"><!-- Header with Kennummer, PrÃ¼fungsname, Timer, etc. -->
    <div class="w-full bg-white shadow-lg p-4 mb-4 flex justify-between items-start fixed top-0 left-0 right-0 z-40"><!-- Left: Kennummer and PrÃ¼fungsname -->
     <div class="flex gap-8 items-center">
      <div>
       <div class="text-sm font-semibold text-gray-600">
        Kennummer:
       </div>
       <div id="header-kennummer" class="text-lg font-bold text-gray-800"></div>
      </div>
      <div>
       <div class="text-lg font-bold text-blue-600" id="header-pruefungsname"></div>
      </div>
     </div><!-- Right: Controls -->
     <div class="flex items-center gap-4"><!-- GrÃ¶ÃŸe der Funktionsleiste -->
      <div class="flex gap-2 items-center"><button onclick="changeToolbarSize('small')" id="btn-small" class="px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-sm"> A </button> <button onclick="changeToolbarSize('medium')" id="btn-medium" class="px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-base font-semibold"> A </button> <button onclick="changeToolbarSize('large')" id="btn-large" class="px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-lg font-bold"> A </button>
      </div><!-- Timer -->
      <div class="text-center">
       <div id="timer" class="text-2xl font-bold text-gray-800">
        06:00 Stunden
       </div>
      </div><!-- Prï¿½ï¿½ï¿½ï¿½fung beenden Button --> <button onclick="showEndExamDialog()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-lg shadow-lg transition-all"> PrÃ¼fung beenden </button>
     </div>
    </div><!-- Toolbar -->
    <div class="w-full bg-white shadow-lg p-3 flex flex-wrap gap-2 border-b-2 border-gray-200 mb-2 fixed z-30" style="top: 80px;"><!-- 1. Rï¿½ï¿½ckgÃ¤ngig --> <button onclick="undo()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="RÃ¼ckgÃ¤ngig (Strg+Z)"> ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ </button> <!-- 2. Wiederholen --> <button onclick="redo()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Wiederholen (Strg+Y)"> ï¿½ï¿½ </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 3. Ausschneiden --> <button onclick="cutText()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Ausschneiden (Strg+X)"> ï¿½ï¿½ï¿½ </button> <!-- 4. Kopieren --> <button onclick="copyText()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Kopieren (Strg+C)"> ï¿½ï¿½ï¿½ï¿½ </button> <!-- 5. EinfÃ¼gen --> <button onclick="pasteText()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="EinfÃ¼gen (Strg+V)"> ðŸ“„ </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 5b. Seitenumbruch --> <button onclick="insertPageBreak()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Seitenumbruch"> âŽ¯âŽ¯ </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 6. Kopfzeile oder Absatz --> <select id="formatType" onchange="changeFormatType(this.value)" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 border-none cursor-pointer" title="Format"> <option value="p" selected>Absatz</option> <option value="h2">Kopfzeile</option> </select>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 7. Texthervorhebungsfarbe --> <select onchange="highlightText(this.value)" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 border-none cursor-pointer" title="Texthervorhebung"> <option value="">Farbauswahl aufheben</option> <option value="#d3d3d3">Grau</option> </select>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 8. Fett --> <button onclick="formatText('bold')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 font-bold" title="Fett"> B </button> <!-- 9. Kursiv --> <button onclick="formatText('italic')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 italic" title="Kursiv"> I </button> <!-- 10. Durchgestrichen --> <button onclick="formatText('strikeThrough')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 line-through" title="Durchgestrichen"> S </button> <!-- 11. Hochgestellt --> <button onclick="formatText('superscript')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Hochgestellt"> xÂ² </button> <!-- 12. Tiefgestellt --> <button onclick="formatText('subscript')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Tiefgestellt"> xï¿½ï¿½ï¿½ </button> <!-- 13. Rot unterstrichen --> <button onclick="redUnderline()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-red-600 underline" title="Rot unterstrichen"> U </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 14. LinksbÃ¼ndig --> <button onclick="formatText('justifyLeft')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="LinksbÃ¼ndig"> ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ </button> <!-- 15. Zentrieren --> <button onclick="formatText('justifyCenter')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Zentrieren"> â†” </button> <!-- 16. Rechtsbï¿½ï¿½ndig --> <button onclick="formatText('justifyRight')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="RechtsbÃ¼ndig"> âž¡ </button> <!-- 17. Blocksatz --> <button onclick="formatText('justifyFull')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Blocksatz"> ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ </button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 18. AufzÃ¤hlung --> <button onclick="formatText('insertUnorderedList')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="AufzÃ¤hlung">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line> <line x1="8" y1="12" x2="21" y2="12"></line> <line x1="8" y1="18" x2="21" y2="18"></line> <circle cx="4" cy="6" r="1" fill="currentColor"></circle> <circle cx="4" cy="12" r="1" fill="currentColor"></circle> <circle cx="4" cy="18" r="1" fill="currentColor"></circle>
      </svg></button> <!-- 19. Nummerierte Liste --> <button onclick="formatText('insertOrderedList')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Nummerierte Liste">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="10" y1="6" x2="21" y2="6"></line> <line x1="10" y1="12" x2="21" y2="12"></line> <line x1="10" y1="18" x2="21" y2="18"></line> <path d="M4 6h1v4" stroke-width="1.5"></path> <path d="M4 10h2" stroke-width="1.5"></path> <path d="M6 15H4c0-1 2-2 2-3s-1-1.5-1-1.5S4 11 4 12" stroke-width="1.5"></path> <path d="M4 19h2v-1H5v-1h1" stroke-width="1.5"></path>
      </svg></button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 20. GeschÃ¼tztes Leerzeichen --> <button onclick="insertNonBreakingSpace()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="GeschÃ¼tztes Leerzeichen">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="10" width="4" height="4" fill="currentColor" opacity="0.3"></rect> <rect x="14" y="10" width="4" height="4" fill="currentColor" opacity="0.3"></rect>
      </svg></button> <!-- 21. Einzug verkleinern --> <button onclick="formatText('outdent')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Einzug verkleinern">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"></polyline> <line x1="18" y1="18" x2="6" y2="18"></line> <line x1="18" y1="14" x2="13" y2="14"></line> <line x1="18" y1="10" x2="13" y2="10"></line> <line x1="18" y1="6" x2="6" y2="6"></line>
      </svg></button> <!-- 22. Einzug vergrÃ¶ÃŸern --> <button onclick="formatText('indent')" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Einzug vergrÃ¶ÃŸern">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 7 18 12 13 17"></polyline> <line x1="18" y1="18" x2="6" y2="18"></line> <line x1="18" y1="14" x2="13" y2="14"></line> <line x1="18" y1="10" x2="13" y2="10"></line> <line x1="18" y1="6" x2="6" y2="6"></line>
      </svg></button>
     <div class="w-px bg-gray-300 mx-1"></div><!-- 23. Tabelle einfÃ¼gen --> <button onclick="showTableDialog()" class="toolbar-button px-3 py-2 rounded bg-gray-100 hover:bg-gray-200" title="Tabelle einfÃ¼gen">
      <svg width="18" height="18" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect> <line x1="3" y1="9" x2="21" y2="9"></line> <line x1="3" y1="15" x2="21" y2="15"></line> <line x1="9" y1="3" x2="9" y2="21"></line> <line x1="15" y1="3" x2="15" y2="21"></line>
      </svg></button>
    </div><!-- Spacer for fixed headers -->
    <div style="height: 180px;"></div><!-- Table Dialog as Pop-up -->
    <div id="tableDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
     <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
      <h3 class="font-bold mb-4 text-xl text-gray-800">Tabelle einfÃ¼gen</h3>
      <div class="mb-4">
       <div id="tableGrid" class="inline-block border-2 border-gray-300 rounded"></div>
       <div id="tableSelection" class="mt-3 text-sm font-semibold text-gray-700"></div>
      </div>
     </div>
    </div><!-- Editor Area -->
    <div class="w-full max-w-4xl bg-white rounded-b-lg shadow-lg mb-8 flex" style="min-height: 600px;"><!-- Korrekturrand (1/3 der Breite) - unsichtbar -->
     <div class="w-1/3 bg-white p-4">
     </div><!-- Schreibbereich (2/3 der Breite) -->
     <div class="w-2/3 p-8">
      <div id="editor" class="editor-content" contenteditable="true" style="font-family: 'Georgia', serif; font-size: 16px; line-height: 1.6; color: #333; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap;">
      </div>
     </div>
    </div>
   </div><!-- End Exam Confirmation Dialog -->
   <div id="endExamDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
     <h2 class="text-2xl font-bold text-gray-800 mb-4">PrÃ¼fung beenden?</h2>
     <p class="text-gray-700 mb-6">Wollen Sie die PrÃ¼fung wirklich endgÃ¼ltig beenden?</p>
     <div class="flex gap-4 justify-end"><button onclick="hideEndExamDialog()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-lg transition-all"> Nein </button> <button onclick="endExam()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-all"> Ja, PrÃ¼fung beenden </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      document_title: "Mein Dokument"
    };

    let userKennummer = "";
    let pruefungsname = "";
    let remainingMinutes = 360; // 6 Stunden = 360 Minuten
    let timerInterval = null;

    // Handle login form submission
    function handleLogin(event) {
      event.preventDefault();
      userKennummer = document.getElementById('kennummer').value.trim();
      pruefungsname = document.getElementById('pruefungsname').value.trim();
      
      if (userKennummer && pruefungsname) {
        // Hide login screen
        document.getElementById('loginScreen').classList.add('hidden');
        
        // Show confirmation screen with user's name
        document.getElementById('confirmedName').textContent = userKennummer;
        document.getElementById('confirmationScreen').classList.remove('hidden');
      }
    }

    // Start the editor
    function startEditor() {
      document.getElementById('confirmationScreen').classList.add('hidden');
      document.getElementById('editorScreen').classList.remove('hidden');
      
      // Update header with user info
      document.getElementById('header-kennummer').textContent = userKennummer;
      document.getElementById('header-pruefungsname').textContent = pruefungsname;
      
      // Start timer immediately when confirmation button is clicked
      startTimer();
    }

    // Timer functions
    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        remainingMinutes--;
        updateTimerDisplay();
        
        if (remainingMinutes <= 0) {
          clearInterval(timerInterval);
          showTimeUpDialog();
        }
      }, 60000); // Update every minute (60000 ms)
      
      // Also update every second for more accurate countdown display
      setInterval(() => {
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const timerElement = document.getElementById('timer');
      const hours = Math.floor(remainingMinutes / 60);
      const minutes = remainingMinutes % 60;
      const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} Stunden`;
      timerElement.textContent = formattedTime;
      
      // Keep timer color neutral
      timerElement.classList.add('text-gray-800');
    }

    function showTimeUpDialog() {
      const dialog = document.createElement('div');
      dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      dialog.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
          <h2 class="text-2xl font-bold text-red-600 mb-4">Zeit abgelaufen!</h2>
          <p class="text-gray-700 mb-6">Die PrÃ¼fungszeit ist abgelaufen. Bitte laden Sie Ihr Dokument herunter.</p>
          <button onclick="downloadDocument()" class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">
            Dokument herunterladen
          </button>
        </div>
      `;
      document.body.appendChild(dialog);
    }

    // Change toolbar size
    function changeToolbarSize(size) {
      const toolbar = document.querySelector('#editorScreen > div:nth-of-type(2)');
      
      // Remove active state from all buttons
      document.getElementById('btn-small').className = 'px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-sm';
      document.getElementById('btn-medium').className = 'px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-base font-semibold';
      document.getElementById('btn-large').className = 'px-3 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 text-lg font-bold';
      
      if (size === 'small') {
        toolbar.classList.remove('p-3');
        toolbar.classList.add('p-2');
        toolbar.style.fontSize = '12px';
        document.getElementById('btn-small').className = 'px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-sm';
      } else if (size === 'large') {
        toolbar.classList.remove('p-3');
        toolbar.classList.add('p-4');
        toolbar.style.fontSize = '16px';
        document.getElementById('btn-large').className = 'px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-lg font-bold';
      } else {
        toolbar.classList.remove('p-2', 'p-4');
        toolbar.classList.add('p-3');
        toolbar.style.fontSize = '14px';
        document.getElementById('btn-medium').className = 'px-3 py-2 border-2 border-blue-500 bg-blue-50 rounded-lg hover:bg-blue-100 text-base font-semibold';
      }
    }

    // End exam dialog functions
    function showEndExamDialog() {
      document.getElementById('endExamDialog').classList.remove('hidden');
    }

    function hideEndExamDialog() {
      document.getElementById('endExamDialog').classList.add('hidden');
    }

    async function endExam() {
      clearInterval(timerInterval);
      hideEndExamDialog();
      
      // Show confirmation message
      const message = document.createElement('div');
      message.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
      message.textContent = 'PrÃ¼fung beendet. PDF wird heruntergeladen...';
      document.body.appendChild(message);
      
      // Wait a moment for the message to be visible, then download
      await new Promise(resolve => setTimeout(resolve, 500));
      await downloadDocument();
      
      setTimeout(() => {
        message.remove();
      }, 3000);
    }

    // Format text in editor
    function formatText(command) {
      document.execCommand(command, false, null);
      document.getElementById('editor').focus();
    }

    // 1. RÃ¼ckgÃ¤ngig machen
    function undo() {
      document.execCommand('undo', false, null);
      document.getElementById('editor').focus();
    }

    // 2. Wiederholen
    function redo() {
      document.execCommand('redo', false, null);
      document.getElementById('editor').focus();
    }

    // 3. Ausschneiden
    async function cutText() {
      try {
        const selection = window.getSelection();
        if (selection.toString()) {
          await navigator.clipboard.writeText(selection.toString());
          document.execCommand('delete', false, null);
        }
      } catch (err) {
        // Fallback zu execCommand
        document.execCommand('cut', false, null);
      }
      document.getElementById('editor').focus();
    }

    // 4. Kopieren
    async function copyText() {
      try {
        const selection = window.getSelection();
        if (selection.toString()) {
          await navigator.clipboard.writeText(selection.toString());
        }
      } catch (err) {
        // Fallback zu execCommand
        document.execCommand('copy', false, null);
      }
      document.getElementById('editor').focus();
    }

    // 5. Einfï¿½ï¿½gen
    async function pasteText() {
      try {
        const text = await navigator.clipboard.readText();
        document.execCommand('insertText', false, text);
      } catch (err) {
        // Fallback zu execCommand
        document.execCommand('paste', false, null);
      }
      document.getElementById('editor').focus();
    }

    // 5b. Seitenumbruch einfÃ¼gen
    function insertPageBreak() {
      const pageBreak = '<div style="page-break-after: always; border-top: 2px dashed #999; margin: 20px 0; padding-top: 20px;"></div>';
      document.execCommand('insertHTML', false, pageBreak);
      document.getElementById('editor').focus();
    }

    // 6. Kopfzeile oder Absatz Ã¤ndern
    function changeFormatType(tag) {
      document.execCommand('formatBlock', false, tag);
      document.getElementById('editor').focus();
    }

    // 7. Texthervorhebungsfarbe
    function highlightText(color) {
      if (color === '') {
        document.execCommand('removeFormat', false, null);
      } else {
        document.execCommand('backColor', false, color);
      }
      document.getElementById('editor').focus();
    }

    // 13. Rot unterstrichen
    function redUnderline() {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.textDecoration = 'underline';
        span.style.textDecorationColor = 'red';
        span.style.textDecorationThickness = '2px';
        try {
          range.surroundContents(span);
        } catch (e) {
          // Fallback fÃ¼r komplexe Auswahlen
          const contents = range.extractContents();
          span.appendChild(contents);
          range.insertNode(span);
        }
      }
      document.getElementById('editor').focus();
    }

    // 20. GeschÃ¼tztes Leerzeichen
    function insertNonBreakingSpace() {
      const editor = document.getElementById('editor');
      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        const textNode = document.createTextNode('\u00A0');
        range.insertNode(textNode);
        range.setStartAfter(textNode);
        range.setEndAfter(textNode);
        selection.removeAllRanges();
        selection.addRange(range);
      }
    }

    // 23. Tabelle Dialog anzeigen
    let selectedRows = 3;
    let selectedCols = 3;
    
    function showTableDialog() {
      document.getElementById('tableDialog').classList.remove('hidden');
      createTableGrid();
      
      // Add click listener to background to close dialog
      const dialog = document.getElementById('tableDialog');
      dialog.addEventListener('click', function(e) {
        if (e.target === dialog) {
          hideTableDialog();
        }
      });
    }

    function hideTableDialog() {
      document.getElementById('tableDialog').classList.add('hidden');
    }

    // Erstelle das KÃ¤stchenraster (10x10)
    function createTableGrid() {
      const grid = document.getElementById('tableGrid');
      grid.innerHTML = '';
      
      const maxRows = 10;
      const maxCols = 10;
      
      for (let row = 0; row < maxRows; row++) {
        const rowDiv = document.createElement('div');
        rowDiv.style.display = 'flex';
        
        for (let col = 0; col < maxCols; col++) {
          const cell = document.createElement('div');
          cell.style.width = '20px';
          cell.style.height = '20px';
          cell.style.border = '1px solid #ccc';
          cell.style.cursor = 'pointer';
          cell.style.transition = 'background-color 0.1s';
          cell.dataset.row = row + 1;
          cell.dataset.col = col + 1;
          
          // Hover-Effekt
          cell.addEventListener('mouseenter', function() {
            const hoverRow = parseInt(this.dataset.row);
            const hoverCol = parseInt(this.dataset.col);
            highlightCells(hoverRow, hoverCol);
            updateSelectionText(hoverRow, hoverCol);
          });
          
          // Klick zum AuswÃ¤hlen
          cell.addEventListener('click', function(e) {
            e.stopPropagation();
            selectedRows = parseInt(this.dataset.row);
            selectedCols = parseInt(this.dataset.col);
            insertTableFromGrid();
          });
          
          rowDiv.appendChild(cell);
        }
        
        grid.appendChild(rowDiv);
      }
      
      // Initial Auswahl anzeigen
      highlightCells(3, 3);
      updateSelectionText(3, 3);
    }
    
    // Markiere Zellen bis zur ausgewÃ¤hlten Position
    function highlightCells(rows, cols) {
      const grid = document.getElementById('tableGrid');
      const allCells = grid.querySelectorAll('div[data-row]');
      
      allCells.forEach(cell => {
        const cellRow = parseInt(cell.dataset.row);
        const cellCol = parseInt(cell.dataset.col);
        
        if (cellRow <= rows && cellCol <= cols) {
          cell.style.backgroundColor = '#3b82f6';
        } else {
          cell.style.backgroundColor = 'transparent';
        }
      });
    }
    
    // Zeige aktuelle Auswahl als Text
    function updateSelectionText(rows, cols) {
      const text = document.getElementById('tableSelection');
      text.textContent = `${rows} x ${cols} Tabelle`;
    }

    // Tabelle einfÃ¼gen basierend auf Grid-Auswahl
    function insertTableFromGrid() {
      const editor = document.getElementById('editor');
      
      // Erstelle Tabelle als DOM-Element
      const table = document.createElement('table');
      table.style.borderCollapse = 'collapse';
      table.style.width = '100%';
      table.style.margin = '10px 0';
      
      for (let i = 0; i < selectedRows; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < selectedCols; j++) {
          const cell = document.createElement('td');
          cell.style.border = '1px solid #333';
          cell.style.padding = '8px';
          cell.style.minWidth = '60px';
          cell.contentEditable = 'true';
          cell.innerHTML = '&nbsp;';
          cell.addEventListener('click', function(e) {
            showTableContextMenu(e, this);
          });
          row.appendChild(cell);
        }
        table.appendChild(row);
      }
      
      // FÃ¼ge Tabelle in Editor ein
      editor.focus();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(table);
        
        // FÃ¼ge Leerzeile nach Tabelle hinzu
        const br = document.createElement('br');
        range.setStartAfter(table);
        range.insertNode(br);
        
        // Setze Cursor nach der Tabelle
        range.setStartAfter(br);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        // Fallback: HÃ¤nge am Ende an
        editor.appendChild(table);
        const br = document.createElement('br');
        editor.appendChild(br);
      }
      
      hideTableDialog();
      editor.focus();
    }

    // KontextmenÃ¼ fÃ¼r Tabellenzellen
    let contextMenu = null;
    let currentCell = null;

    function showTableContextMenu(event, cell) {
      event.preventDefault();
      event.stopPropagation();
      
      currentCell = cell;
      
      // Entferne altes KontextmenÃ¼ falls vorhanden
      if (contextMenu) {
        contextMenu.remove();
      }
      
      // Erstelle neues KontextmenÃ¼
      contextMenu = document.createElement('div');
      contextMenu.style.position = 'absolute';
      contextMenu.style.backgroundColor = 'white';
      contextMenu.style.border = '2px solid #ccc';
      contextMenu.style.borderRadius = '8px';
      contextMenu.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
      contextMenu.style.zIndex = '1000';
      contextMenu.style.minWidth = '220px';
      contextMenu.style.padding = '8px 0';
      
      // Positioniere das MenÃ¼ unterhalb der Tabelle in der Mitte
      const table = cell.closest('table');
      const tableRect = table.getBoundingClientRect();
      const editorRect = document.getElementById('editor').getBoundingClientRect();
      
      // Berechne Position relativ zum Editor
      const leftPosition = tableRect.left - editorRect.left + (tableRect.width / 2) - 110; // 110 = halbe MenÃ¼-Breite
      const topPosition = tableRect.bottom - editorRect.top + 10; // 10px Abstand unter der Tabelle
      
      contextMenu.style.left = leftPosition + 'px';
      contextMenu.style.top = topPosition + 'px';
      
      const menuItems = [
        { text: 'Zeile davor einfÃ¼gen', action: () => insertRowBefore(cell) },
        { text: 'Zeile danach einfÃ¼gen', action: () => insertRowAfter(cell) },
        { text: 'Spalte davor einfÃ¼gen', action: () => insertColumnBefore(cell) },
        { text: 'Spalte danach einfÃ¼gen', action: () => insertColumnAfter(cell) },
        { text: '---', action: null },
        { text: 'Tabelle lÃ¶schen', action: () => deleteTable(cell), danger: true }
      ];
      
      menuItems.forEach(item => {
        if (item.text === '---') {
          const divider = document.createElement('div');
          divider.style.height = '1px';
          divider.style.backgroundColor = '#e0e0e0';
          divider.style.margin = '4px 0';
          contextMenu.appendChild(divider);
        } else {
          const menuItem = document.createElement('div');
          menuItem.textContent = item.text;
          menuItem.style.padding = '10px 16px';
          menuItem.style.cursor = 'pointer';
          menuItem.style.fontSize = '14px';
          menuItem.style.color = item.danger ? '#dc2626' : '#333';
          menuItem.style.fontWeight = item.danger ? 'bold' : 'normal';
          
          menuItem.addEventListener('mouseenter', function() {
            this.style.backgroundColor = item.danger ? '#fee2e2' : '#f3f4f6';
          });
          
          menuItem.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'transparent';
          });
          
          menuItem.addEventListener('click', function() {
            item.action();
            hideContextMenu();
          });
          
          contextMenu.appendChild(menuItem);
        }
      });
      
      document.body.appendChild(contextMenu);
      
      // SchlieÃŸe MenÃ¼ beim Klick auÃŸerhalb
      setTimeout(() => {
        document.addEventListener('click', hideContextMenu);
      }, 100);
    }

    function hideContextMenu() {
      if (contextMenu) {
        contextMenu.remove();
        contextMenu = null;
      }
      document.removeEventListener('click', hideContextMenu);
    }

    function insertRowBefore(cell) {
      const row = cell.closest('tr');
      const table = cell.closest('table');
      const colCount = row.cells.length;
      
      const newRow = document.createElement('tr');
      for (let i = 0; i < colCount; i++) {
        const newCell = document.createElement('td');
        newCell.style.border = '1px solid #333';
        newCell.style.padding = '8px';
        newCell.style.minWidth = '60px';
        newCell.contentEditable = 'true';
        newCell.onclick = function(e) { showTableContextMenu(e, this); };
        newCell.innerHTML = '&nbsp;';
        newRow.appendChild(newCell);
      }
      
      row.parentNode.insertBefore(newRow, row);
    }

    function insertRowAfter(cell) {
      const row = cell.closest('tr');
      const table = cell.closest('table');
      const colCount = row.cells.length;
      
      const newRow = document.createElement('tr');
      for (let i = 0; i < colCount; i++) {
        const newCell = document.createElement('td');
        newCell.style.border = '1px solid #333';
        newCell.style.padding = '8px';
        newCell.style.minWidth = '60px';
        newCell.contentEditable = 'true';
        newCell.onclick = function(e) { showTableContextMenu(e, this); };
        newCell.innerHTML = '&nbsp;';
        newRow.appendChild(newCell);
      }
      
      if (row.nextSibling) {
        row.parentNode.insertBefore(newRow, row.nextSibling);
      } else {
        row.parentNode.appendChild(newRow);
      }
    }

    function insertColumnBefore(cell) {
      const table = cell.closest('table');
      const cellIndex = cell.cellIndex;
      
      const rows = table.querySelectorAll('tr');
      rows.forEach(row => {
        const newCell = document.createElement('td');
        newCell.style.border = '1px solid #333';
        newCell.style.padding = '8px';
        newCell.style.minWidth = '50px';
        newCell.style.maxWidth = '100%';
        newCell.style.wordWrap = 'break-word';
        newCell.style.overflowWrap = 'break-word';
        newCell.contentEditable = 'true';
        newCell.onclick = function(e) { showTableContextMenu(e, this); };
        newCell.innerHTML = '&nbsp;';
        row.insertBefore(newCell, row.cells[cellIndex]);
      });
    }

    function insertColumnAfter(cell) {
      const table = cell.closest('table');
      const cellIndex = cell.cellIndex;
      
      const rows = table.querySelectorAll('tr');
      rows.forEach(row => {
        const newCell = document.createElement('td');
        newCell.style.border = '1px solid #333';
        newCell.style.padding = '8px';
        newCell.style.minWidth = '50px';
        newCell.style.maxWidth = '100%';
        newCell.style.wordWrap = 'break-word';
        newCell.style.overflowWrap = 'break-word';
        newCell.contentEditable = 'true';
        newCell.onclick = function(e) { showTableContextMenu(e, this); };
        newCell.innerHTML = '&nbsp;';
        
        if (cellIndex + 1 < row.cells.length) {
          row.insertBefore(newCell, row.cells[cellIndex + 1]);
        } else {
          row.appendChild(newCell);
        }
      });
    }

    function deleteTable(cell) {
      const table = cell.closest('table');
      if (table) {
        table.remove();
      }
    }

    // TastaturkÃ¼rzel
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 'z':
            if (!e.shiftKey) {
              e.preventDefault();
              undo();
            }
            break;
          case 'y':
            e.preventDefault();
            redo();
            break;
          case 'x':
            // Browser-Standard wird verwendet
            break;
          case 'c':
            // Browser-Standard wird verwendet
            break;
          case 'v':
            // Browser-Standard wird verwendet
            break;
        }
      }
    });

    // Clear editor
    function clearEditor() {
      const editor = document.getElementById('editor');
      editor.innerHTML = '';
      editor.focus();
    }

    // Download document as PDF (using print dialog)
    function downloadDocument() {
      // Create print content if it doesn't exist
      let printDiv = document.getElementById('printContent');
      if (!printDiv) {
        printDiv = document.createElement('div');
        printDiv.id = 'printContent';
        printDiv.style.display = 'none';
        document.body.appendChild(printDiv);
      }
      
      const editor = document.getElementById('editor');
      
      // Create header
      const header = `
        <div class="print-header">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div><strong>Kennummer:</strong> ${userKennummer}</div>
            <div style="text-align: center;"><strong>${pruefungsname}</strong></div>
          </div>
        </div>
      `;
      
      // Clone editor content
      const content = editor.cloneNode(true);
      content.classList.add('print-content');
      
      // Wrap content in a layout with correction margin
      const layoutWrapper = `
        <div style="display: flex; width: 100%;">
          <div style="width: 33.33%; border-right: 1px solid #ccc;"></div>
          <div style="width: 66.67%; padding-left: 20px;">
            ${content.outerHTML}
          </div>
        </div>
      `;
      
      // Set print content
      printDiv.innerHTML = header + layoutWrapper;
      printDiv.style.display = 'block';
      
      // Set document title for PDF filename (used by print dialog)
      const originalTitle = document.title;
      document.title = `${pruefungsname}_${userKennummer}`;
      
      // Trigger print dialog
      window.print();
      
      // Restore original title and hide print content after printing
      setTimeout(() => {
        document.title = originalTitle;
        printDiv.style.display = 'none';
      }, 1000);
    }

    // Element SDK implementation
    async function onConfigChange(config) {
      const titleElement = document.getElementById('doc-title');
      titleElement.textContent = config.document_title || defaultConfig.document_title;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["document_title", config.document_title || defaultConfig.document_title]
      ]);
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ad91346352e9884',t:'MTc2NTY2NjgwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
